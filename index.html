<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug Palace - Sz√°ll√≠t√°si Lista (Google Maps)</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; margin-bottom: 10px; }
        .file-input-wrapper { display: inline-block; margin: 10px 0; }
        .file-input-label { display: inline-block; padding: 12px 24px; background: #4CAF50; color: white; border-radius: 6px; cursor: pointer; font-weight: 500; }
        input[type="file"] { display: none; }
        .file-name { margin-left: 15px; color: #666; }
        .main-content { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
        .sidebar { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-height: calc(100vh - 150px); overflow-y: auto; }
        .order-item { padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; transition: all 0.2s; background: white; position: relative; }
        .order-item:not(.editing):hover { border-color: #4CAF50; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
        .order-item.has-order { border-color: #007bff; background: #eaf2ff; }
        .order-item.geocoding-failed { background-color: #fff0f0; border-color: #e0b0b0; }
        .geocoding-error-message { font-size: 12px; color: #c0392b; font-weight: 600; margin-top: 8px; text-align: center; }
        .order-number-badge { position: absolute; top: 10px; right: 10px; background: #007bff; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; }
        .order-status { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 8px; }
        .status-teljesitve { background: #C6EFCE; color: #155724; }
        .status-feldolgozas, .status-feldgozas { background: #FFEB9C; color: #856404; }
        .status-fizetes-folyamatban { background: #DDEBF7; color: #004085; }
        .status-fizetes-elott { background: #FFC7CE; color: #721c24; }
        .order-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .order-phone, .order-address { font-size: 14px; color: #555; margin-bottom: 4px; }
        .order-address-original { font-size: 12px; color: #888; margin-top: 4px; font-style: italic; word-break: break-all; }
        .edit-form { display: none; padding-top: 10px; border-top: 1px dashed #ccc; margin-top: 10px; }
        .order-item.editing .order-details { display: none; }
        .order-item.editing .edit-form { display: block; }
        .edit-form-group { margin-bottom: 8px; }
        .edit-form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #555; }
        .edit-form-group input { width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
        .edit-form-buttons { display: flex; gap: 10px; margin-top: 12px; }
        .btn-action { padding: 8px 12px; font-size: 13px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
        .btn-save-geocode { background-color: #007bff; color: white; flex-grow: 1; }
        .btn-cancel-edit { background-color: #6c757d; color: white; }
        .btn-save-geocode.success { background-color: #28a745 !important; }
        .btn-save-geocode.error { background-color: #dc3545 !important; }
        #map { height: calc(100vh - 150px); width: 100%; border-radius: 8px; }
        .info-box, .warning-box { padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; }
        .info-box { background: #e3f2fd; color: #1976d2; }
        .warning-box { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöö Sz√°ll√≠t√°si Lista optimaliz√°l√≥</h1>
            <p>T√∂ltsd fel az export f√°jlt, majd a "Szerkeszt√©s" gombbal jav√≠tsd a pontatlan c√≠meket.</p>
            <div style="margin-top: 15px;">
                <div class="file-input-wrapper"><label class="file-input-label" for="file-upload">üìÅ Excel f√°jl kiv√°laszt√°sa</label><input type="file" id="file-upload" accept=".xlsx, .xls"></div>
                <span class="file-name" id="file-name">Nincs f√°jl kiv√°lasztva</span>
            </div>
        </header>
        <div class="main-content">
            <div class="sidebar" id="sidebar">
                 <div class="info-box">A kezd√©shez t√∂lts fel egy export√°lt Excel f√°jlt.</div>
            </div>
            <div id="map"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="config.js"></script>

    <script>
        let map, geocoder, autocomplete;
        let orders = [], markers = [], orderedStops = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 47.1625, lng: 19.5033 },
                zoom: 7,
                mapTypeControl: false,
                streetViewControl: false
            });
            geocoder = new google.maps.Geocoder();
        }
        
        function loadGoogleMapsScript() {
            if (typeof GOOGLE_API_KEY === 'undefined' || GOOGLE_API_KEY.includes('IDE_ILLESZD_BE')) {
                alert('HIBA: Az API kulcs nincs megadva a config.js f√°jlban!');
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&libraries=places&callback=initMap`;
            script.async = true;
            document.head.appendChild(script);
        }
        window.onload = loadGoogleMapsScript;

        document.getElementById('file-upload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('file-name').textContent = file.name;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    orders = processRawWooCommerce(rawData);
                    renderSidebar();
                    await geocodeAllOrders();
                } catch (error) {
                    console.error('Hiba a f√°jl feldolgoz√°sa sor√°n:', error);
                    document.getElementById('sidebar').innerHTML = '<div class="warning-box">F√°jlfeldolgoz√°si hiba! Ellen≈ërizd a f√°jl form√°tum√°t.</div>';
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function findColumn(columns, keywords) {
            return columns.find(col => keywords.every(kw => col.toLowerCase().includes(kw.toLowerCase())));
        }

        // --- VISSZA√ÅLL√çTOTT, M≈∞K√ñD≈ê ADATFELDOLGOZ√ì ---
        function processRawWooCommerce(rawData) {
            const columns = Object.keys(rawData[0]);
            
            // Rugalmas kulcsszavas keres√©s
            const colMap = {
                num: findColumn(columns, ['order', 'number']),
                status: findColumn(columns, ['order', 'status']),
                fName: findColumn(columns, ['first name', 'shipping']),
                lName: findColumn(columns, ['last name', 'shipping']),
                addr: findColumn(columns, ['address', 'shipping']),
                city: findColumn(columns, ['city', 'shipping']),
                postcode: findColumn(columns, ['postcode', 'shipping']),
                phone: findColumn(columns, ['phone', 'shipping']) || findColumn(columns, ['phone', 'billing'])
            };

            const grouped = {};
            rawData.forEach(row => {
                const orderNum = row[colMap.num];
                if (!orderNum || grouped[orderNum]) return;
                
                const addressParts = [];
                if (row[colMap.addr]) addressParts.push(String(row[colMap.addr]).trim());
                if (row[colMap.city]) addressParts.push(String(row[colMap.city]).trim());
                if (row[colMap.postcode]) addressParts.push(String(row[colMap.postcode]).trim());
                
                const finalAddress = addressParts.join(', ');

                grouped[orderNum] = {
                    orderNumber: orderNum,
                    status: row[colMap.status] || 'Ismeretlen',
                    name: `${row[colMap.lName] || ''} ${row[colMap.fName] || ''}`.trim(),
                    phone: colMap.phone ? String(row[colMap.phone]) : '',
                    address: finalAddress,
                    originalAddress: finalAddress,
                    location: null
                };
            });
            return Object.values(grouped);
        }


        async function geocodeAllOrders() {
            for (let i = 0; i < orders.length; i++) {
                const order = orders[i];
                const success = await geocodeSingleOrder(order.orderNumber, order.address);
                const orderDiv = document.querySelector(`.order-item[data-ordernumber="${order.orderNumber}"]`);
                if (orderDiv) {
                    updateOrderItemView(orderDiv, order);
                }
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            updateMapAndMarkers();
        }

        async function geocodeSingleOrder(orderNumber, address) {
            const order = orders.find(o => o.orderNumber === orderNumber);
            if (!order || !address || address.trim() === '') return false;
            
            try {
                const request = { address: address, componentRestrictions: { country: 'HU' } };
                const { results } = await geocoder.geocode(request);
                if (results && results[0]) {
                    order.location = results[0].geometry.location;
                    order.address = results[0].formatted_address;
                    return true;
                }
            } catch (error) {
                console.error(`Geok√≥dol√°si hiba a ${orderNumber} rendelsn√©l:`, error);
            }
            order.location = null;
            return false;
        }
        
        function renderSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = `
                <div class="info-box">Kattints a sorokra a k√≠v√°nt sorrend be√°ll√≠t√°s√°hoz.</div>
                <div id="order-list"></div>
            `;
            const orderList = document.getElementById('order-list');
            orders.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'order-item';
                orderDiv.dataset.ordernumber = order.orderNumber;
                orderList.appendChild(orderDiv);
                updateOrderItemView(orderDiv, order);
            });
        }

        function updateOrderItemView(orderDiv, order) {
            const position = orderedStops.indexOf(order.orderNumber) + 1;
            orderDiv.classList.toggle('has-order', !!position);
            orderDiv.classList.toggle('geocoding-failed', !order.location);
            orderDiv.classList.remove('editing');

            orderDiv.innerHTML = `
                ${position ? `<div class="order-number-badge">${position}</div>` : ''}
                <div class="order-details">
                    <div class="order-status ${getStatusClass(order.status)}">${order.status}</div>
                    <div class="order-name">${order.name}</div>
                    <div class="order-phone">üìû ${order.phone || 'Nincs megadva'}</div>
                    <div class="order-address">üìç ${order.address}</div>
                    <div class="order-address-original">Eredeti: ${order.originalAddress}</div>
                    ${!order.location ? '<div class="geocoding-error-message">‚ö†Ô∏è C√≠m nem tal√°lhat√≥!</div>' : ''}
                    <button class="btn-action btn-edit" style="margin-top: 8px;">Szerkeszt√©s</button>
                </div>
                <div class="edit-form">
                    <div class="edit-form-group">
                        <label>C√≠m keres√©se (kezdj el g√©pelni)</label>
                        <input type="text" class="edit-address-autocomplete" value="${order.address}">
                    </div>
                    <div class="edit-form-buttons">
                        <button class="btn-action btn-cancel-edit">M√©gse</button>
                        <button class="btn-action btn-save-geocode">Ment√©s √©s √öjrak√≥dol√°s</button>
                    </div>
                </div>
            `;
        }

        document.getElementById('sidebar').addEventListener('click', async (e) => {
            const orderItem = e.target.closest('.order-item');
            if (!orderItem) return;
            const orderNumber = Number(orderItem.dataset.ordernumber);

            if (e.target.classList.contains('btn-edit')) {
                orderItem.classList.add('editing');
                const input = orderItem.querySelector('.edit-address-autocomplete');
                autocomplete = new google.maps.places.Autocomplete(input, {
                    componentRestrictions: { country: "hu" },
                    fields: ["formatted_address"],
                });
                input.focus();
            }
            else if (e.target.classList.contains('btn-cancel-edit')) {
                orderItem.classList.remove('editing');
            }
            else if (e.target.classList.contains('btn-save-geocode')) {
                const button = e.target;
                button.textContent = 'K√≥dol√°s...';
                button.disabled = true;

                const addressInput = orderItem.querySelector('.edit-address-autocomplete').value;
                const success = await geocodeSingleOrder(orderNumber, addressInput);
                
                button.textContent = success ? '‚úì Sikeres!' : '‚ùå Hiba!';
                button.classList.add(success ? 'success' : 'error');
                
                setTimeout(() => {
                    const order = orders.find(o => o.orderNumber === orderNumber);
                    updateOrderItemView(orderItem, order);
                    updateMapAndMarkers();
                }, 1500);
            }
            else if (!orderItem.classList.contains('editing')) {
                toggleOrderSequence(orderNumber);
            }
        });

        function toggleOrderSequence(orderNumber) {
            const order = orders.find(o => o.orderNumber === orderNumber);
            if (!order || !order.location) return;
            
            const index = orderedStops.indexOf(orderNumber);
            if (index > -1) {
                orderedStops.splice(index, 1);
            } else {
                orderedStops.push(orderNumber);
            }
            updateMapAndMarkers();
            document.querySelectorAll('.order-item').forEach(div => {
                const num = Number(div.dataset.ordernumber);
                const pos = orderedStops.indexOf(num) + 1;
                const badge = div.querySelector('.order-number-badge');
                if (pos) {
                    div.classList.add('has-order');
                    if (badge) badge.textContent = pos;
                    else div.insertAdjacentHTML('afterbegin', `<div class="order-number-badge">${pos}</div>`);
                } else {
                    div.classList.remove('has-order');
                    if (badge) badge.remove();
                }
            });
        }

        function updateMapAndMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            const bounds = new google.maps.LatLngBounds();
            const geocodedOrders = orders.filter(o => o.location);
            
            if(geocodedOrders.length === 0) {
                map.setCenter({ lat: 47.1625, lng: 19.5033 });
                map.setZoom(7);
                return;
            };

            geocodedOrders.forEach(order => {
                const position = orderedStops.indexOf(order.orderNumber) + 1;
                const marker = new google.maps.Marker({
                    position: order.location,
                    map: map,
                    label: position ? String(position) : '',
                    title: order.name,
                });
                markers.push(marker);
                bounds.extend(order.location);
            });
            
            if (geocodedOrders.length > 1) {
                 map.fitBounds(bounds);
            } else if (geocodedOrders.length === 1) {
                map.setCenter(bounds.getCenter());
                map.setZoom(15);
            }
        }

        function getStatusClass(status) { 
            const statusMap = { 'Teljes√≠tve': 'status-teljesitve', 'Feldolgoz√°s alatt': 'status-feldolgozas', 'Fizet√©s folyamatban': 'status-fizetes-folyamatban', 'Fizet√©s el≈ëtt': 'status-fizetes-elott' };
            return statusMap[status] || 'status-feldolgozas'; 
        }
        
    </script>
</body>
</html>
