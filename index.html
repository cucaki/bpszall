<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rendel√©sek kezel√©se</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .orders-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 700px;
      margin: 0 auto;
    }
    .order {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }
    .order-number-badge {
      position: absolute;
      top: -10px;
      left: -10px;
      background: #4CAF50;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .order-status {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 6px;
      display: inline-block;
      margin-bottom: 5px;
    }
    .order-status.active { background: #4caf50; color: white; }
    .order-status.pending { background: #ff9800; color: white; }
    .order-status.cancelled { background: #f44336; color: white; }
    .order-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .btn-toggle-edit, .btn-regeocode {
      border: none;
      background: #1976d2;
      color: white;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-regeocode {
      background: #4caf50;
    }
    .btn-toggle-edit:disabled, .btn-regeocode:disabled {
      background: #999;
      cursor: not-allowed;
    }
    input[type="text"] {
      width: 100%;
      padding: 6px;
      margin-bottom: 4px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .geocoding-error-message {
      color: red;
      font-size: 13px;
    }
  </style>
</head>
<body>

  <h1>Rendel√©sek kezel√©se</h1>

  <div id="orders" class="orders-container"></div>

  <script>
    // P√©ldaadatok
    const orders = [
      {
        orderNumber: "1001",
        name: "Kiss P√©ter",
        phone: "+36 30 111 2233",
        addressSegments: { street: "Pet≈ëfi utca 12", city: "Szeged", postcode: "6720" },
        address: "Pet≈ëfi utca 12, Szeged, 6720",
        status: "active",
        lat: 46.253,
        lon: 20.148
      },
      {
        orderNumber: "1002",
        name: "Nagy Anna",
        phone: "+36 70 555 7788",
        addressSegments: { street: "R√°k√≥czi t√©r 3", city: "Debrecen", postcode: "4025" },
        address: "R√°k√≥czi t√©r 3, Debrecen, 4025",
        status: "pending"
      }
    ];

    let editingOrder = null;
    const orderedStops = [];

    function getStatusClass(status) {
      switch (status) {
        case "active": return "active";
        case "pending": return "pending";
        case "cancelled": return "cancelled";
        default: return "";
      }
    }

    function buildFullAddress(segments) {
      const { street, city, postcode } = segments;
      return [street, city, postcode].filter(Boolean).join(", ");
    }

    // F≈ë renderel≈ë
    function renderOrders() {
      const container = document.getElementById("orders");
      container.innerHTML = "";
      orders.forEach((order, index) => {
        const isEditing = editingOrder === order.orderNumber;
        const hasCoords = order.lat && order.lon;

        const addressHTML = isEditing
          ? `
            <input id="street-${order.orderNumber}" type="text" value="${order.addressSegments?.street || ""}" placeholder="Utca" />
            <input id="city-${order.orderNumber}" type="text" value="${order.addressSegments?.city || ""}" placeholder="V√°ros" />
            <input id="postcode-${order.orderNumber}" type="text" value="${order.addressSegments?.postcode || ""}" placeholder="Ir√°ny√≠t√≥sz√°m" />
          `
          : `<div><b>C√≠m:</b> ${order.address}</div>`;

        const orderDiv = document.createElement("div");
        orderDiv.className = "order";
        orderDiv.innerHTML = `
          <div class="order-number-badge">${index + 1}</div>
          <div class="order-status ${getStatusClass(order.status)}">${order.status}</div>
          <div class="order-name"><b>${order.name}</b></div>
          <div class="order-phone">üìû ${order.phone}</div>
          ${addressHTML}
          ${!hasCoords ? '<div class="geocoding-error-message">‚ö†Ô∏è Nincs koordin√°ta</div>' : ""}
          <div class="order-actions">
            <button id="edit-btn-${order.orderNumber}" class="btn-toggle-edit" onclick="event.stopPropagation(); handleEditClick(${JSON.stringify(order.orderNumber)})">
              ${isEditing ? "‚úÖ Ment√©s" : "‚úèÔ∏è Szerkeszt√©s"}
            </button>
            <button id="geocode-btn-${order.orderNumber}" class="btn-regeocode" onclick="event.stopPropagation(); handleGeocodeClick(${JSON.stringify(order.orderNumber)})">
              üîÑ √öjrak√≥dol√°s
            </button>
          </div>
        `;
        container.appendChild(orderDiv);
      });
    }

    // Szerkeszt√©s
    function handleEditClick(orderNumber) {
      orderNumber = String(orderNumber);
      console.log("EDIT CLICK:", orderNumber);

      if (editingOrder === orderNumber) {
        const order = orders.find(o => String(o.orderNumber) === orderNumber);
        if (!order) return;

        const streetEl = document.getElementById(`street-${orderNumber}`);
        const cityEl = document.getElementById(`city-${orderNumber}`);
        const postcodeEl = document.getElementById(`postcode-${orderNumber}`);

        const street = streetEl ? streetEl.value.trim() : "";
        const city = cityEl ? cityEl.value.trim() : "";
        const postcode = postcodeEl ? postcodeEl.value.trim() : "";

        order.addressSegments = { street, city, postcode };
        order.address = buildFullAddress(order.addressSegments);

        editingOrder = null;
      } else {
        editingOrder = orderNumber;
      }
      renderOrders();
    }

    // Geok√≥dol√°s szimul√°l√°sa
    async function geocodeAddress(address) {
      console.log("GEOCODING:", address);
      // Csak demo c√©lra: "fake" koordin√°t√°k
      return new Promise(resolve => {
        setTimeout(() => {
          if (address.toLowerCase().includes("szeged"))
            resolve({ lat: 46.25, lon: 20.15 });
          else if (address.toLowerCase().includes("debrecen"))
            resolve({ lat: 47.53, lon: 21.63 });
          else resolve(null);
        }, 1000);
      });
    }

    // √öjrak√≥dol√°s
    async function handleGeocodeClick(orderNumber) {
      orderNumber = String(orderNumber);
      console.log("GEOCODE CLICK:", orderNumber);
      const order = orders.find(o => String(o.orderNumber) === orderNumber);
      if (!order) return;

      const button = document.getElementById(`geocode-btn-${orderNumber}`);
      if (button) {
        button.textContent = "K√≥dol√°s...";
        button.disabled = true;
      }

      if (editingOrder === orderNumber) {
        handleEditClick(orderNumber);
      }

      const coords = await geocodeAddress(order.address);
      if (coords) {
        order.lat = coords.lat;
        order.lon = coords.lon;
      } else {
        delete order.lat;
        delete order.lon;
        const idx = orderedStops.indexOf(orderNumber);
        if (idx > -1) orderedStops.splice(idx, 1);
      }

      if (button) {
        button.textContent = "üîÑ √öjrak√≥dol√°s";
        button.disabled = false;
      }

      renderOrders();
    }

    // Ind√≠t√°s
    renderOrders();
  </script>
</body>
</html>
