<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bug Palace - Sz√°ll√≠t√°si Lista</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background:#f5f5f5; color:#333; }
    .container { max-width:1400px; margin:0 auto; padding:20px; }
    header { background:#fff; padding:20px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,.1); }
    h1 { font-size:24px; margin-bottom:10px; }

    .file-input-wrapper { display:inline-block; margin:10px 0; }
    .file-input-label { display:inline-block; padding:12px 24px; background:#4CAF50; color:#fff; border-radius:6px; cursor:pointer; font-weight:500; }
    .file-input-label:hover { background:#45a049; }
    input[type="file"] { display:none; }
    .file-name { margin-left:15px; color:#666; }

    .main-content { display:grid; grid-template-columns:400px 1fr; gap:20px; }
    @media (max-width:1024px){ .main-content{ grid-template-columns:1fr; } }

    .sidebar { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.1); max-height:calc(100vh - 200px); overflow-y:auto; }
    .filters { margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #eee; }
    .filter-group label { display:block; font-weight:600; margin-bottom:8px; font-size:14px; }
    .checkbox-group { display:flex; flex-direction:column; gap:8px; }
    .checkbox-item { display:flex; align-items:center; gap:8px; }
    .checkbox-item input { width:18px; height:18px; cursor:pointer; }
    .checkbox-item label { cursor:pointer; }

    .stats{ background:#f9f9f9; padding:12px; border-radius:6px; margin-bottom:15px; font-size:13px; }
    .stats-row{ display:flex; justify-content:space-between; margin-bottom:6px; }
    .stats-label{ font-weight:600; }

    .action-buttons{ margin-bottom:20px; display:flex; flex-direction:column; gap:10px; }
    .btn{ padding:12px 20px; border:none; border-radius:6px; font-weight:600; cursor:pointer; transition:.2s; font-size:14px; }
    .btn-primary{ background:#2196F3; color:#fff; } .btn-primary:hover{ background:#1976D2; }
    .btn-success{ background:#4CAF50; color:#fff; } .btn-success:hover{ background:#45a049; }
    .btn-neutral{ background:#f0f0f0; color:#333; } .btn-neutral:hover{ background:#e0e0e0; }
    .btn:disabled{ background:#ccc; cursor:not-allowed; }

    .order-list { margin-top:20px; }
    .order-item { padding:12px; border:1px solid #e0e0e0; border-radius:6px; margin-bottom:10px; background:#fff; position:relative; transition:.15s; cursor:pointer; }
    .order-item:hover{ border-color:#4CAF50; box-shadow:0 2px 4px rgba(0,0,0,.08); }
    .order-item.has-order{ border-color:#2196F3; background:#e3f2fd; }
    .order-item.geocoding-failed{ background:#fff7f7; border-color:#e8bcbc; }
    .order-item.edit-mode{ background:#fffef0; }
    .order-actions, .order-actions * { cursor:default; }

    .order-number-badge{
      position:absolute; top:8px; right:8px; background:#2196F3; color:#fff; width:28px; height:28px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; pointer-events:none;
    }

    .order-status{ display:inline-block; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600; margin-bottom:6px; }
    .status-teljesitve{ background:#C6EFCE; color:#155724; }
    .status-feldolgozas{ background:#FFEB9C; color:#856404; }
    .status-fizetes-folyamatban{ background:#DDEBF7; color:#004085; }
    .status-fizetes-elott{ background:#FFC7CE; color:#721c24; }

    .order-name{ font-weight:600; margin-bottom:4px; }
    .order-phone{ font-size:13px; color:#666; margin-bottom:4px; }

    .address-segments{ display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:6px; }
    .address-field{ display:flex; flex-direction:column; }
    .address-field.full-width{ grid-column:1 / -1; }
    .address-label{ font-size:10px; color:#999; text-transform:uppercase; font-weight:600; margin-bottom:2px; }
    .address-input{ padding:6px 8px; border:1px solid #ddd; border-radius:4px; font-size:13px; font-family:inherit; }
    .address-input:focus{ outline:none; border-color:#2196F3; background:#f9f9f9; }
    .address-display{ font-size:13px; color:#444; padding:6px; background:#f9f9f9; border-radius:4px; margin-top:4px; }
    .address-original{ font-size:12px; color:#888; padding:6px; margin-top:6px; border-left:3px solid #e0e0e0; background:#fbfbfb; }

    .order-actions{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn-toggle-edit{ background:#2196F3; color:#fff; padding:8px 14px; border:none; border-radius:4px; font-weight:600; }
    .btn-toggle-edit:hover{ background:#1976D2; }
    .btn-restore-original{ background:#ffe082; color:#333; padding:8px 14px; border:none; border-radius:4px; font-weight:600; }
    .btn-restore-original:hover{ background:#ffd54f; }

    .geocoding-chip{
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; margin-top:8px;
    }
    .chip-ok{ background:#E8F5E9; color:#1B5E20; border:1px solid #C8E6C9; }
    .chip-fail{ background:#FFEBEE; color:#B71C1C; border:1px solid #FFCDD2; }
    .chip-pending{ background:#E3F2FD; color:#0D47A1; border:1px solid #BBDEFB; }
    .chip-ok a{ color:inherit; text-decoration:underline; }

    .map-container{ background:#fff; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.1); overflow:hidden; position:relative; }
    #map{ height:calc(100vh - 200px); min-height:500px; width:100%; z-index:1; }

    .no-data{ text-align:center; padding:40px; color:#999; }
    .progress-bar{ width:100%; height:6px; background:#e0e0e0; border-radius:3px; overflow:hidden; margin:10px 0; }
    .progress-fill{ height:100%; background:#4CAF50; transition:width .3s; }
    .info-box{ background:#e3f2fd; padding:12px; border-radius:6px; margin-bottom:15px; font-size:13px; color:#1976d2; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üêõ Bug Palace - Sz√°ll√≠t√°si Lista</h1>
      <p>T√∂ltsd fel a WooCommerce export f√°jlt, szerkeszd a c√≠meket!</p>
      <div style="margin-top:15px;">
        <div class="file-input-wrapper">
          <label class="file-input-label" for="file-upload">üìÅ Excel kiv√°laszt√°sa</label>
          <input type="file" id="file-upload" accept=".xlsx, .xls">
        </div>
        <span class="file-name" id="file-name">Nincs f√°jl kiv√°lasztva</span>
      </div>
    </header>

    <div class="main-content">
      <div class="sidebar">
        <div class="filters">
          <div class="filter-group">
            <label>Rendel√©s st√°tusza:</label>
            <div class="checkbox-group">
              <div class="checkbox-item"><input type="checkbox" id="status-teljesitve" value="Teljes√≠tve"><label for="status-teljesitve">Teljes√≠tve</label></div>
              <div class="checkbox-item"><input type="checkbox" id="status-feldolgozas" value="Feldolgoz√°s alatt" checked><label for="status-feldolgozas">Feldolgoz√°s alatt</label></div>
              <div class="checkbox-item"><input type="checkbox" id="status-fizetes-folyamatban" value="Fizet√©s folyamatban" checked><label for="status-fizetes-folyamatban">Fizet√©s folyamatban</label></div>
              <div class="checkbox-item"><input type="checkbox" id="status-fizetes-elott" value="Fizet√©s el≈ëtt" checked><label for="status-fizetes-elott">Fizet√©s el≈ëtt</label></div>
            </div>
          </div>
        </div>

        <div class="info-box">üí° A geok√≥dolatlan c√≠mek **fel√ºlre** ker√ºlnek. Szerkeszt√©s ut√°n a ‚Äû‚úÖ Ment√©s + geok√≥dol√°s‚Äù gomb **azonnal k√≥dolja**, √©s a k√°rty√°n l√°tszik, hogy siker√ºlt-e.</div>

        <div class="stats" id="stats">
          <div class="stats-row"><span class="stats-label">√ñsszes:</span><span id="total-orders">0</span></div>
          <div class="stats-row"><span class="stats-label">Geok√≥dolt:</span><span id="geocoded-count">0</span></div>
          <div class="stats-row"><span class="stats-label">Sorrendben:</span><span id="ordered-count">0</span></div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-success" id="calculate-route-btn" disabled>üó∫Ô∏è Optimaliz√°l√°s</button>
          <button class="btn btn-primary" id="copy-list-btn" disabled>üìã M√°sol√°s</button>
        </div>

        <div class="order-list" id="order-list">
          <div class="no-data">T√∂lts fel egy Excel f√°jlt</div>
        </div>
      </div>

      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    let map, markers = [], routePolyline = null, orders = [], orderedStops = [], editingOrder = null;

    function initMap() {
      map = L.map('map').setView([47.1625, 19.5033], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'¬© OpenStreetMap',
        maxZoom:19
      }).addTo(map);
    }

    function getStatusClass(status){
      const m = {
        'Teljes√≠tve':'status-teljesitve',
        'Feldolgoz√°s alatt':'status-feldolgozas',
        'Fizet√©s folyamatban':'status-fizetes-folyamatban',
        'Fizet√©s el≈ëtt':'status-fizetes-elott'
      };
      return m[status] || 'status-feldolgozas';
    }

    function getSelectedStatuses(){
      return Array.from(document.querySelectorAll('.checkbox-group input:checked')).map(cb => cb.value);
    }

    function findColumn(columns, keywords){
      return columns.find(col => keywords.every(kw => col.toLowerCase().includes(kw.toLowerCase())));
    }

    function parseAddress(fullAddress){
      const parts = String(fullAddress).split(',').map(s => s.trim());
      const result = { street:'', city:'', postcode:'' };
      parts.forEach(part => {
        if (/^\d{4}$/.test(part)) result.postcode = part;
        else if (part.toLowerCase().includes('budapest') || /^[A-Z√Å√â√ç√ì√ñ≈ê√ö√ú≈∞][a-z√°√©√≠√≥√∂≈ë√∫√º≈±]+$/.test(part)) result.city = part;
        else if (part) result.street = part;
      });
      return result;
    }

    function buildFullAddress(s){
      const out = [];
      if (s.street) out.push(s.street);
      if (s.city) out.push(s.city);
      if (s.postcode) out.push(s.postcode);
      return out.join(', ');
    }

    function processRawWooCommerce(raw){
      const columns = Object.keys(raw[0] || {});
      const colMap = {
        num: findColumn(columns, ['order','number']),
        status: findColumn(columns, ['status']),
        fName: findColumn(columns, ['first','shipping']),
        lName: findColumn(columns, ['last','shipping']),
        addr: findColumn(columns, ['address','shipping']),
        city: findColumn(columns, ['city','shipping']),
        postcode: findColumn(columns, ['postcode','shipping']),
        phone: findColumn(columns, ['phone','shipping']) || findColumn(columns, ['phone','billing'])
      };

      const grouped = {};
      raw.forEach(row => {
        const orderNumRaw = row[colMap.num];
        if (!orderNumRaw) return;
        const orderNum = String(orderNumRaw).trim();
        if (grouped[orderNum]) return;

        const parts = [];
        if (row[colMap.addr]) parts.push(String(row[colMap.addr]).trim());
        if (row[colMap.city]) {
          let c = String(row[colMap.city]).trim();
          if (c.toLowerCase().includes('budapest')) c = 'Budapest';
          parts.push(c);
        }
        if (row[colMap.postcode]) parts.push(String(row[colMap.postcode]).trim());
        const full = parts.join(', ');

        grouped[orderNum] = {
          orderNumber: orderNum,
          status: String(row[colMap.status] || '').trim(),
          name: `${row[colMap.lName] || ''} ${row[colMap.fName] || ''}`.trim(),
          phone: colMap.phone ? String(row[colMap.phone] || '').trim() : '',
          originalAddress: full,
          address: full,
          addressSegments: parseAddress(full),
          lat: undefined,
          lon: undefined
        };
      });
      return Object.values(grouped);
    }

    async function geocodeAddress(address){
      try{
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Hungary')}&limit=1`;
        const res = await fetch(url, { headers: { 'Accept-Language':'hu,en;q=0.8' }});
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0){
          return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
        }
      }catch(e){ console.error('Geocoding error:', e); }
      return null;
    }

    document.getElementById('file-upload').addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById('file-name').textContent = file.name;

      const reader = new FileReader();
      reader.onload = async (ev)=>{
        try{
          const data = new Uint8Array(ev.target.result);
          const wb = XLSX.read(data, { type:'array' });
          const sheet = wb.SheetNames[0];
          const raw = XLSX.utils.sheet_to_json(wb.Sheets[sheet] || {});
          document.getElementById('order-list').innerHTML = '<div class="no-data">Feldolgoz√°s...</div>';

          orders = processRawWooCommerce(raw);
          const toGeo = orders.filter(o => getSelectedStatuses().includes(o.status));

          const prog = document.createElement('div');
          prog.className = 'no-data';
          prog.innerHTML = `
            <div>Geok√≥dol√°s...</div>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            <div><span id="geocode-progress">0</span>/${toGeo.length}</div>
          `;
          const listEl = document.getElementById('order-list');
          listEl.innerHTML = '';
          listEl.appendChild(prog);

          for (let i=0; i<toGeo.length; i++){
            const o = toGeo[i];
            const coords = await geocodeAddress(o.address);
            if (coords){ o.lat = coords.lat; o.lon = coords.lon; }
            const pr = Math.round(((i+1)/toGeo.length)*100);
            document.getElementById('progress-fill').style.width = pr + '%';
            document.getElementById('geocode-progress').textContent = String(i+1);
            await new Promise(r=>setTimeout(r,1100));
          }

          renderOrders();
          updateMap();
          updateStats();
        }catch(err){
          console.error(err);
          document.getElementById('order-list').innerHTML = '<div class="no-data" style="color:red;">Hiba a feldolgoz√°sban!</div>';
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function getFilteredOrders(){ const sel = getSelectedStatuses(); return orders.filter(o => sel.includes(o.status)); }

    function getOrderPosition(orderNumber){
      const key = String(orderNumber);
      const idx = orderedStops.indexOf(key);
      return idx !== -1 ? idx + 1 : null;
    }

    function toggleOrderSequence(orderNumber){
      const key = String(orderNumber);
      const ord = orders.find(o => String(o.orderNumber) === key);
      if (!ord || !ord.lat || !ord.lon) return;
      const idx = orderedStops.indexOf(key);
      if (idx !== -1) orderedStops.splice(idx,1); else orderedStops.push(key);
      renderOrders(); updateMap(); updateStats();
    }

    function buildGoogleMapsLink(order) {
      if (order.lat && order.lon) return `https://www.google.com/maps?q=${order.lat},${order.lon}`;
      const target = order.address?.trim() || order.originalAddress?.trim() || '';
      if (!target) return '';
      return `https://www.google.com/maps?q=${encodeURIComponent(target)}`;
    }

    function geocodeChipHTML(o){
      if (o.lat && o.lon){
        const link = buildGoogleMapsLink(o);
        return `<span class="geocoding-chip chip-ok">‚úÖ Geok√≥dolt ‚Ä¢ <a href="${link}" target="_blank" rel="noopener">Megnyit√°s</a></span>`;
      }
      return `<span class="geocoding-chip chip-fail">‚ùå Geok√≥dolatlan</span>`;
    }

    // === RENDER LIST: geok√≥dolatlanok fel√ºl, azt√°n sorrend szerint ===
    function renderOrders(){
      const wrap = document.getElementById('order-list');
      const filtered = getFilteredOrders();
      if (filtered.length === 0){ wrap.innerHTML = '<div class="no-data">Nincs rendel√©s</div>'; return; }
      wrap.innerHTML = '';

      const sorted = [...filtered].sort((a,b)=>{
        const aHas = !!(a.lat && a.lon);
        const bHas = !!(b.lat && b.lon);
        if (aHas !== bHas) return aHas ? 1 : -1; // NINCS geok√≥d -> el≈ëre
        const pa = getOrderPosition(a.orderNumber);
        const pb = getOrderPosition(b.orderNumber);
        if (pa && pb) return pa - pb;
        if (pa) return -1;
        if (pb) return 1;
        return 0;
      });

      sorted.forEach(order=>{
        const key = String(order.orderNumber);
        const pos = getOrderPosition(key);
        const hasCoords = !!(order.lat && order.lon);
        const isEditing = editingOrder === key;

        const item = document.createElement('div');
        item.className = 'order-item';
        item.dataset.order = key;
        if (pos) item.classList.add('has-order');
        if (!hasCoords) item.classList.add('geocoding-failed');
        if (isEditing) item.classList.add('edit-mode');

        const addressHTML = isEditing
          ? `
            <div class="address-segments">
              <div class="address-field full-width">
                <span class="address-label">Utca + h√°zsz√°m</span>
                <input class="address-input" id="street-${key}" value="${order.addressSegments.street || ''}" placeholder="pl. Andr√°ssy √∫t 1.">
              </div>
              <div class="address-field">
                <span class="address-label">V√°ros</span>
                <input class="address-input" id="city-${key}" value="${order.addressSegments.city || ''}" placeholder="pl. Budapest">
              </div>
              <div class="address-field">
                <span class="address-label">Ir√°ny√≠t√≥sz√°m</span>
                <input class="address-input" id="postcode-${key}" value="${order.addressSegments.postcode || ''}" placeholder="pl. 1061">
              </div>
            </div>
            <div class="address-original">üóÇ <strong>Eredeti c√≠m:</strong> ${order.originalAddress}</div>
          `
          : `
            <div class="address-display">üìç ${order.address}</div>
            <div class="address-original">üóÇ <strong>Eredeti c√≠m:</strong> ${order.originalAddress}</div>
          `;

        const actionsHTML = isEditing
          ? `
            <button type="button" class="btn-toggle-edit">‚úÖ Ment√©s + geok√≥dol√°s</button>
            <button type="button" class="btn-restore-original">‚Ü©Ô∏è Eredeti c√≠m bet√∂lt√©se</button>
          `
          : `
            <button type="button" class="btn-toggle-edit">‚úèÔ∏è Szerkeszt√©s</button>
          `;

        item.innerHTML = `
          ${pos ? `<div class="order-number-badge">${pos}</div>` : ''}
          <div class="order-status ${getStatusClass(order.status)}">${order.status}</div>
          <div class="order-name">${order.name}</div>
          <div class="order-phone">üìû ${order.phone}</div>
          ${addressHTML}
          <div class="geocode-chip-wrap" id="chip-${key}">
            ${geocodeChipHTML(order)}
          </div>
          <div class="order-actions">
            ${actionsHTML}
          </div>
        `;

        // K√°rty√°ra kattint√°s = sorrendbe t√©tel (de szerkeszt√©s k√∂zben ne)
        item.addEventListener('click', (ev)=>{
          if (editingOrder === key) return;
          // ne kapja el a gombok kattint√°s√°t
          if (ev.target.closest('.order-actions')) return;
          toggleOrderSequence(key);
        });

        wrap.appendChild(item);
      });
    }

    // ESEM√âNYDELEG√ÅL√ÅS A GOMBOKRA
    document.getElementById('order-list').addEventListener('click', async (e)=>{
      const item = e.target.closest('.order-item');
      if (!item) return;
      const key = item.dataset.order;
      const order = orders.find(o => String(o.orderNumber) === key);
      if (!order) return;

      const editBtn = e.target.closest('.btn-toggle-edit');
      const restoreBtn = e.target.closest('.btn-restore-original');

      if (restoreBtn){
        e.stopPropagation();
        const seg = parseAddress(order.originalAddress || '');
        const s = document.getElementById(`street-${key}`);
        const c = document.getElementById(`city-${key}`);
        const p = document.getElementById(`postcode-${key}`);
        if (s) s.value = seg.street || '';
        if (c) c.value = seg.city || '';
        if (p) p.value = seg.postcode || '';
        return;
      }

      if (editBtn){
        e.stopPropagation();

        if (editingOrder === key){
          // MENT√âS + azonnali GEOK√ìDOL√ÅS
          const s = (document.getElementById(`street-${key}`)?.value || '').trim();
          const c = (document.getElementById(`city-${key}`)?.value || '').trim();
          const p = (document.getElementById(`postcode-${key}`)?.value || '').trim();

          order.addressSegments = { street: s, city: c, postcode: p };
          order.address = buildFullAddress(order.addressSegments);

          // UI: pending chip + gomb √°llapot
          const chip = document.getElementById(`chip-${key}`);
          if (chip) chip.innerHTML = `<span class="geocoding-chip chip-pending">‚è≥ Geok√≥dol√°s...</span>`;
          editBtn.disabled = true; editBtn.textContent = 'K√≥dol√°s...';

          const coords = await geocodeAddress(order.address);
          if (coords){ order.lat = coords.lat; order.lon = coords.lon; }
          else { delete order.lat; delete order.lon; }

          editingOrder = null;
          renderOrders(); updateMap(); updateStats();
          return;
        } else {
          // bel√©p√©s szerkeszt√©s m√≥dba
          editingOrder = key;
          renderOrders(); // friss√≠ti a gombot "Ment√©s + geok√≥dol√°s"-ra
          // f√≥kusz az els≈ë mez≈ëre
          setTimeout(()=> {
            const s = document.getElementById(`street-${key}`);
            if (s) s.focus();
          }, 0);
          return;
        }
      }
    });

    function updateMap(){
      if (!map) return;
      markers.forEach(m => map.removeLayer(m)); markers = [];
      if (routePolyline){ map.removeLayer(routePolyline); routePolyline = null; }

      const geocoded = getFilteredOrders().filter(o => o.lat && o.lon);
      if (geocoded.length === 0) return;

      geocoded.forEach(o=>{
        const key = String(o.orderNumber);
        const pos = getOrderPosition(key);
        const colorMap = {
          'Teljes√≠tve':'green',
          'Feldolgoz√°s alatt':'orange',
          'Fizet√©s folyamatban':'blue',
          'Fizet√©s el≈ëtt':'red'
        };
        const color = colorMap[o.status] || 'gray';
        const html = pos
          ? `<div style="background-color:${color};width:32px;height:32px;border-radius:50%;border:3px solid #fff;box-shadow:0 0 6px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:16px;">${pos}</div>`
          : `<div style="background-color:${color};width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 4px rgba(0,0,0,.5);"></div>`;

        const icon = L.divIcon({ className:'custom-marker', html, iconSize: pos ? [32,32] : [12,12] });
        const marker = L.marker([o.lat, o.lon], { icon })
          .bindPopup(`<strong>${o.name}</strong><br>üìû ${o.phone}<br>üìç ${o.address}`)
          .addTo(map);
        marker.on('click', ()=> toggleOrderSequence(key));
        markers.push(marker);
      });

      if (markers.length){
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }

      if (orderedStops.length >= 2){
        const coords = orderedStops
          .map(num => orders.find(o => String(o.orderNumber) === String(num)))
          .filter(o => o && o.lat && o.lon)
          .map(o => [o.lat, o.lon]);
        if (coords.length >= 2){
          routePolyline = L.polyline(coords, { color:'#2196F3', weight:3, opacity:.7, dashArray:'10,5' }).addTo(map);
        }
      }
    }

    function updateStats(){
      const filtered = getFilteredOrders();
      const geoc = filtered.filter(o => o.lat && o.lon).length;
      document.getElementById('total-orders').textContent = String(filtered.length);
      document.getElementById('geocoded-count').textContent = String(geoc);
      document.getElementById('ordered-count').textContent = String(orderedStops.length);
      document.getElementById('calculate-route-btn').disabled = orderedStops.length < 2;
      document.getElementById('copy-list-btn').disabled = orderedStops.length === 0;
    }

    document.querySelectorAll('.checkbox-group input').forEach(cb=>{
      cb.addEventListener('change', ()=>{ renderOrders(); updateMap(); updateStats(); });
    });

    // COPY: N√©v, Telefon, EREDETI c√≠m, Google Maps link
    document.getElementById('copy-list-btn').addEventListener('click', ()=>{
      if (!orderedStops.length) return;
      const lines = [];
      for (let i=0;i<orderedStops.length;i++){
        const key = String(orderedStops[i]);
        const o = orders.find(x => String(x.orderNumber) === key);
        if (!o) continue;
        const name = o.name || '';
        const phone = o.phone || '';
        const addressOriginal = o.originalAddress || o.address || '';
        const gmaps = buildGoogleMapsLink(o);
        lines.push(`${i+1}. ${name}\n${phone}\n${addressOriginal}\n${gmaps}`.trim());
      }
      const text = lines.join('\n');
      navigator.clipboard.writeText(text).then(()=> alert('‚úÖ V√°g√≥lapra m√°solva!'));
    });

    // Egyszer≈± NN-optimaliz√°l√°s
    document.getElementById('calculate-route-btn').addEventListener('click', ()=>{
      if (orderedStops.length < 2) return;
      const btn = document.getElementById('calculate-route-btn');
      btn.textContent = 'Sz√°m√≠t√°s...'; btn.disabled = true;

      setTimeout(()=>{
        const coords = orderedStops.map(num=>{
          const o = orders.find(x => String(x.orderNumber) === String(num));
          return o ? { num:String(num), lat:o.lat, lon:o.lon } : null;
        }).filter(Boolean);

        if (coords.length < 2){ btn.textContent = 'üó∫Ô∏è Optimaliz√°l√°s'; btn.disabled = false; return; }

        function dist(a,b){
          const R=6371, dLat=(b.lat-a.lat)*Math.PI/180, dLon=(b.lon-a.lon)*Math.PI/180;
          const t = Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLon/2)**2;
          return R*2*Math.atan2(Math.sqrt(t), Math.sqrt(1-t));
        }

        const opt=[coords[0]], rem=coords.slice(1);
        while (rem.length){
          const cur = opt[opt.length-1];
          let ni=0, md=dist(cur, rem[0]);
          for (let i=1;i<rem.length;i++){ const d=dist(cur, rem[i]); if (d<md){ md=d; ni=i; } }
          opt.push(rem[ni]); rem.splice(ni,1);
        }

        orderedStops = opt.map(o => o.num);
        btn.textContent = 'üó∫Ô∏è Optimaliz√°l√°s'; btn.disabled = false;
        renderOrders(); updateMap(); updateStats();
        alert('‚úÖ √ötvonal optimaliz√°lva!');
      }, 120);
    });

    window.addEventListener('load', initMap);
  </script>
</body>
</html>
